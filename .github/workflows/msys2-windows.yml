name: CMake msys2 Windows 10

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 3'
  workflow_dispatch:

jobs:
    build:
      runs-on: windows-latest
      strategy:
        fail-fast: false
        matrix:
          include:
          - { icon: 'ðŸŸ¦', sys: mingw64 }
      name: ðŸš§${{ matrix.icon }} ${{ matrix.sys }}
      defaults:
        run:
          shell: msys2 {0}
      steps:
      - name: 'ðŸ§° Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{matrix.sys}}
          update: true
          install: >-
            git
            python
            base-devel
            libxslt-devel
          pacboy: >-
            toolchain:p
            cmake:p
            make:p
            ninja:p
            gcc:p
      # ----------------------------------------------------------
      - name: Download FPC Installer 32-Bit Windows
        run: |
          curl -L -o fpc-installer.exe https://sourceforge.net/projects/freepascal/files/Windows/3.2.2/fpc-3.2.2.i386-win32.exe/download
      - name: Download FPC 64-Bit Installer
        run: |
          curl -L -o fpc-installer.exe https://sourceforge.net/projects/freepascal/files/Windows/3.2.2/fpc-3.2.2.x86_64-win64.exe/download
      # ----------------------------------------------------------
      - name: Install FPC 32-Bit
        run: |
          fpc-installer.exe /VERYSILENT /DIR="C:\fpc32"
      - name: Install FPC 64-Bit
        run: |
          fpc-installer.exe /VERYSILENT /DIR="C:\fpc64"
      # ----------------------------------------------------------
      - name: Add FPC to PATH
        shell: cmd
        run: |
          setx PATH "%PATH%;C:\fpc64\bin\x86_64-win64"
          setx PATH "%PATH%;C:\fpc32\bin\i386-win32"
      # ----------------------------------------------------------
      - name: Verify FPC Installation
        shell: cmd
        run: |
          fpc -iW
      # ----------------------------------------------------------
      - name: 'ðŸš§ Build TinyRTL for FPC'
        run: |
          pacman -S fpc
